name: Autowiki
on:
  schedule:
  - cron: "5 4 * * *"
  workflow_dispatch:
permissions:
  contents: read

jobs:
  autowiki:
    runs-on: ubuntu-20.04
    steps:
    - name: "Check for AUTOWIKI_USERNAME"
      id: secrets_set
      env:
        ENABLER_SECRET: ${{ secrets.AUTOWIKI_USERNAME }}
      run: |
        unset SECRET_EXISTS
        if [ -n "$ENABLER_SECRET" ]; then SECRET_EXISTS=true ; fi
        echo "SECRETS_ENABLED=$SECRET_EXISTS" >> $GITHUB_OUTPUT
    - name: Checkout
      if: steps.secrets_set.outputs.SECRETS_ENABLED
      uses: actions/checkout@v3
    - name: Restore BYOND cache
      if: steps.secrets_set.outputs.SECRETS_ENABLED
      uses: actions/cache@v3
      with:
        path: ~/BYOND
        key: ${{ runner.os }}-byond-${{ secrets.CACHE_PURGE_KEY }}
    - name: Install rust-g
      if: steps.secrets_set.outputs.SECRETS_ENABLED
      run: |
        sudo dpkg --add-architecture i386
        sudo apt update || true
        sudo apt install -o APT::Immediate-Configure=false libssl1.1:i386
        bash tools/ci/install_rust_g.sh
    - name: Compile and generate Autowiki files
      if: steps.secrets_set.outputs.SECRETS_ENABLED
      run: |
        bash tools/ci/install_byond.sh
        source $HOME/BYOND/byond/bin/byondsetup
        tools/build/build --ci autowiki
    - name: Run Autowiki
      if: steps.secrets_set.outputs.SECRETS_ENABLED
      env:
        USERNAME: ${{ secrets.AUTOWIKI_USERNAME }}
        PASSWORD: ${{ secrets.AUTOWIKI_PASSWORD }}
      run: |
        cd tools/autowiki
        npm install
        cd ../..
        node tools/autowiki/autowiki.js data/autowiki_edits.txt data/autowiki_files/
